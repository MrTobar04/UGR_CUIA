<!DOCTYPE html>
<html>
<head>
  <title>Grabador por nivel de sonido</title>
</head>
<body>
  <h1>Grabando por sonido</h1>
  <script>
    const threshold = 0.05; // Nivel de volumen mínimo para activar grabación
    const silenceDelay = 2000; // Tiempo en ms de silencio para detener grabación

    let audioContext;
    let analyser;
    let dataArray;
    let mediaRecorder;
    let silenceTimeout;
    let recording = false;
    let chunks = [];

    grabacionActivada = true;
    
     async function init() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);

        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        dataArray = new Uint8Array(analyser.frequencyBinCount);

        source.connect(analyser);

        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(chunks, { type: 'audio/webm' });
          chunks = [];
          const url = URL.createObjectURL(audioBlob);
          const audio = new Audio(url);
          audio.controls = true;
          document.body.appendChild(audio);
        };

        monitorVolume();
      } catch (err) {
        console.error("Error al acceder al micrófono:", err);
      }
    }

    function getVolume() {
      analyser.getByteFrequencyData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i];
      }
      return sum / dataArray.length / 255; // Normalizado entre 0 y 1
    }

    function monitorVolume() {
      setInterval(() => {
        if (!grabacionActivada) return;

        const volume = getVolume();

        if (volume > threshold) {
          if (!recording) {
            mediaRecorder.start();
            recording = true;
            console.log("🎤 Grabación iniciada...");
          }

          clearTimeout(silenceTimeout);
          silenceTimeout = setTimeout(() => {
            if (recording) {
              mediaRecorder.stop();
              recording = false;
              console.log("🛑 Grabación detenida por silencio.");
            }
          }, silenceDelay);
        }
      }, 100); // Mayor frecuencia para mejor respuesta
    }

    function getVolume() {
      analyser.getByteFrequencyData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i];
      }
      return sum / dataArray.length / 255; // Normalizado entre 0 y 1
    }

    function monitorVolume() {
      setInterval(() => {
        const volume = getVolume();
        // console.log("Volumen:", volume.toFixed(3));

        if (volume > threshold) {
          if (!recording) {
            mediaRecorder.start();
            recording = true;
            console.log("🎤 Grabación iniciada...");
          }

          clearTimeout(silenceTimeout);
          silenceTimeout = setTimeout(() => {
            if (recording) {
              mediaRecorder.stop();
              recording = false;
              console.log("🛑 Grabación detenida por silencio.");
            }
          }, silenceDelay);
        }
      }, 75); // Comprobar volumen cada 200ms
    }

    init();
  </script>
</body>
</html>
